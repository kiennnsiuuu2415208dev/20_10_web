<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChÃºc má»«ng 20/10 ğŸ’</title>

  <!-- Basic CSP: cho phÃ©p chá»‰ táº£i script/style tá»« chÃ­nh trang vÃ  google fonts; img tá»« https -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; img-src https: data:;">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- referrerpolicy=no-referrer NGÄ‚N gá»­i referrer khi trÃ¬nh duyá»‡t táº£i avatar -->
  <img id="avatar" src="https://i.imgur.com/vUJh5eP.jpeg" alt="Avatar" referrerpolicy="no-referrer" crossorigin="anonymous" loading="eager">
  <h1 id="mainGreeting">ğŸ’– ChÃºc báº¡n 20/10 vui váº» ğŸ’–</h1>
  <p id="subGreeting">ChÃºc báº¡n ngÃ y cÃ ng xinh Ä‘áº¹p, há»c giá»i hÆ¡n vÃ  Ä‘á»— NV1 nhÃ©! ğŸŒ¸</p>

  <script>
    // -----------------------------
    // An toÃ n & xá»­ lÃ½ Ä‘áº§u vÃ o
    // -----------------------------

    // Láº¥y param an toÃ n
    function getParam(name) {
      try {
        const params = new URLSearchParams(window.location.search);
        return params.has(name) ? params.get(name) : null;
      } catch (e) { return null; }
    }

    // Decode an toÃ n vÃ  giá»›i háº¡n Ä‘á»™ dÃ i chuá»—i (trÃ¡nh payload dÃ i báº¥t thÆ°á»ng)
    function safeDecodeAndLimit(s, maxLen=40) {
      if (!s) return null;
      try {
        const d = decodeURIComponent(s);
        // Loáº¡i bá» kÃ­ tá»± Ä‘iá»u khiá»ƒn
        const clean = d.replace(/[\x00-\x1F\x7F]/g, '').trim();
        return clean.length > maxLen ? clean.slice(0, maxLen) : clean;
      } catch(e) {
        // fallback: tráº£ nguyÃªn
        const fallback = String(s).replace(/[\x00-\x1F\x7F]/g, '').trim();
        return fallback.length > maxLen ? fallback.slice(0, maxLen) : fallback;
      }
    }

    // Kiá»ƒm tra URL áº£nh há»£p lá»‡ (báº¯t Ä‘áº§u báº±ng http/https, khÃ´ng chá»©a "javascript:")
    function isValidImageUrl(u) {
      if (!u || typeof u !== 'string') return false;
      const low = u.trim().toLowerCase();
      if (!(low.startsWith('http://') || low.startsWith('https://'))) return false;
      if (low.includes('javascript:')) return false;
      // trÃ¡nh URL quÃ¡ dÃ i
      if (u.length > 2000) return false;
      return true;
    }

    const rawName = getParam('name');
    const rawAvatar = getParam('avatar');

    const name = safeDecodeAndLimit(rawName, 40);
    const avatar = (() => {
      const a = safeDecodeAndLimit(rawAvatar, 150);
      return isValidImageUrl(a) ? a : null;
    })();

    // GÃ¡n tÃªn an toÃ n (textContent => khÃ´ng thá»±c thi HTML)
    if (name) {
      const h = document.getElementById('mainGreeting');
      h.textContent = `ğŸ’– ChÃºc ${name} 20/10 vui váº» ğŸ’–`;
    }

    // Fallback áº£nh (public)
    function setFallback() {
      const fallback = [
        "https://i.imgur.com/jfF0D8H.jpg",
        "https://i.imgur.com/He9f1Va.jpg",
        "https://i.imgur.com/XHzg3Wq.jpg"
      ];
      const imgEl = document.getElementById('avatar');
      imgEl.src = fallback[Math.floor(Math.random()*fallback.length)];
      imgEl.onerror = null; // trÃ¡nh vÃ²ng láº·p
    }

    // Äáº·t avatar náº¿u há»£p lá»‡; náº¿u khÃ´ng -> fallback
    (function applyAvatar() {
      const imgEl = document.getElementById('avatar');
      if (avatar) {
        imgEl.src = avatar;
        // Náº¿u avatar khÃ´ng táº£i Ä‘Æ°á»£c (háº¿t háº¡n), dÃ¹ng fallback
        imgEl.onerror = setFallback;
      } else {
        setFallback();
      }
    })();

    // Hiá»‡u á»©ng tim rÆ¡i (khÃ´ng gá»­i dá»¯ liá»‡u Ä‘i Ä‘Ã¢u)
    (function hearts() {
      const numHearts = 25;
      function createHeart() {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.textContent = 'ğŸ’–';
        heart.style.left = Math.random() * 100 + 'vw';
        heart.style.animationDuration = 3 + Math.random() * 5 + 's';
        heart.style.fontSize = 10 + Math.random() * 30 + 'px';
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 8000);
      }
      for (let i=0;i<numHearts;i++) createHeart();
      setInterval(createHeart, 500);
    })();

    // KHÃ”NG gá»­i gÃ¬ vá» server, KHÃ”NG lÆ°u localStorage, KHÃ”NG ghi log.
  </script>
</body>
</html>
